<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Report</title>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f4f6f8; padding: 20px; margin: 0; }
    .form { max-width: 700px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; }
    h2 { text-align: center; margin-bottom: 24px; }
    textarea { width: 100%; margin-bottom: 15px; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px; }
    .signature-pad { border: 1px solid #ddd; width: 100%; height: 120px; background: #fff; border-radius: 6px; }
    .sig-btn { margin-top: 8px; padding: 6px 12px; background: #e74c3c; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    .btn-primary { background: #0077cc; color: #fff; border: none; border-radius: 6px; padding: 12px 20px; font-size: 16px; cursor: pointer; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="form">
    <h2>Condition Report</h2>
    <textarea id="conditionReport" placeholder="Enter condition report (max 6 lines)"></textarea>

    <div>
      <label>Employee Signature:</label>
      <canvas id="empSig" class="signature-pad"></canvas>
      <button class="sig-btn" onclick="clearCanvas('empSig')">Clear Employee Signature</button>
    </div>

    <button class="btn-primary" onclick="generatePDF()">Generate & Share</button>
  </div>

  <script>
    let drawing = false;
    function setupSigPad(canvas) {
      const ctx = canvas.getContext("2d");
      canvas.addEventListener("pointerdown", e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
      canvas.addEventListener("pointermove", e => { if (!drawing) return; ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); });
      canvas.addEventListener("pointerup", () => drawing = false);
      canvas.addEventListener("pointerleave", () => drawing = false);
    }
    function clearCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    setupSigPad(document.getElementById("empSig"));

    async function generatePDF() {
      const existingPdfBytes = await fetch("Report.pdf").then(res => res.arrayBuffer());
      const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
      const pages = pdfDoc.getPages();
      const firstPage = pages[0];
      const { height } = firstPage.getSize();

      const startX = 63; // from PDF-XChange
      const startY_topOrigin = 237.53;
      const startY = height - startY_topOrigin; // convert to bottom-left origin

      const lineHeight = 12; // ~10pt Arial with 1.0 spacing
      const conditionText = document.getElementById("conditionReport").value.split("\n").slice(0, 6);

      conditionText.forEach((line, i) => {
        firstPage.drawText(line || '', { x: startX, y: startY - (i * lineHeight), size: 10, font: pdfDoc.embedStandardFont(PDFLib.StandardFonts.Helvetica) });
      });

      const pngUrl = document.getElementById("empSig").toDataURL();
      const pngImageBytes = await fetch(pngUrl).then(res => res.arrayBuffer());
      const sigImage = await pdfDoc.embedPng(pngImageBytes);
      firstPage.drawImage(sigImage, { x: 70, y: 140, width: 150, height: 40 });

      const pdfBytes = await pdfDoc.save();
      const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
      const files = [new File([pdfBlob], 'FilledReport.pdf')];

      if (navigator.canShare && navigator.canShare({ files })) {
        await navigator.share({ files, title: 'Condition Report', text: 'See attached form' });
      } else {
        const url = URL.createObjectURL(pdfBlob);
        window.open(url);
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TOOL DISPOSITION FORM</title>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f4f6f8; padding: 20px; margin: 0; }
    .form { max-width: 700px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; }
    h2 { text-align: center; margin-bottom: 24px; }
    
    .field-group { margin-bottom: 20px; }
    .field-row { display: flex; gap: 15px; margin-bottom: 15px; }
    .field { flex: 1; }
    
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    input[type="text"], input[type="date"] { 
      width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; 
      border-radius: 6px; box-sizing: border-box; 
    }
    textarea { 
      width: 100%; margin-bottom: 5px; padding: 12px; font-size: 16px; 
      border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
    }
    
    .radio-group { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
    .radio-group label { display: inline-block; margin-right: 20px; font-weight: normal; }
    .radio-group input[type="radio"] { margin-right: 8px; }
    
    .limit-warning { font-size: 12px; color: red; margin-bottom: 15px; display: none; }
    .signature-pad { border: 1px solid #ddd; width: 100%; height: 120px; background: #fff; border-radius: 6px; touch-action: none; }
    .sig-btn { margin-top: 8px; padding: 6px 12px; background: #e74c3c; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    .btn-primary { background: #0077cc; color: #fff; border: none; border-radius: 6px; padding: 12px 20px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    input[type="file"] { margin-top: 15px; display: block; }
  </style>
</head>
<body>
  <div class="form">
    <h2>TOOL DISPOSITION FORM</h2>
    
    <!-- Status Selection -->
    <div class="radio-group">
      <label><strong>Select Status:</strong></label><br>
      <label><input type="radio" name="status" value="lost"> Lost</label>
      <label><input type="radio" name="status" value="damaged"> Damaged/Scrap</label>
      <label><input type="radio" name="status" value="inactivated"> Inactivated</label>
    </div>

    <!-- Equipment Details -->
    <div class="field-group">
      <div class="field-row">
        <div class="field">
          <label>Equipment SNG Number:</label>
          <input type="text" id="equipmentSNG" />
        </div>
        <div class="field">
          <label>Part Description:</label>
          <input type="text" id="partDescription" />
        </div>
      </div>
      
      <div class="field-row">
        <div class="field">
          <label>Manufacturer:</label>
          <input type="text" id="manufacturer" />
        </div>
        <div class="field">
          <label>Model Number:</label>
          <input type="text" id="modelNumber" />
        </div>
      </div>
      
      <div class="field-row">
        <div class="field">
          <label>Part Number:</label>
          <input type="text" id="partNumber" />
        </div>
        <div class="field">
          <label>Serial Number:</label>
          <input type="text" id="serialNumber" />
        </div>
      </div>
      
      <div class="field-row">
        <div class="field">
          <label>Aircraft Serial Number S/N:</label>
          <input type="text" id="aircraftSerial" />
        </div>
        <div class="field"></div>
      </div>
    </div>

    <!-- Name and Date -->
    <div class="field-group">
      <div class="field-row">
        <div class="field">
          <label>Name:</label>
          <input type="text" id="employeeName" />
        </div>
        <div class="field">
          <label>Date:</label>
          <input type="date" id="reportDate" />
        </div>
      </div>
    </div>
    <!-- Employee ID -->
  <div class="field-group">
    <div class="field-row">
      <div class="field">
        <label>Employee ID Number:</label>
        <input type="text" id="employeeId" />
      </div>
    </div>
  </div>

    <!-- Condition Report -->
    <div class="field-group">
      <label>Condition Report:</label>
      <textarea id="conditionReport" placeholder="Enter condition report (max 6 lines)"></textarea>
      <div id="limitWarning" class="limit-warning">Max 6 lines reached - no more text allowed</div>
    </div>

    <!-- Signature -->
    <div class="field-group">
      <label>Employee Signature:</label>
      <canvas id="empSig" class="signature-pad"></canvas>
      <button class="sig-btn" onclick="clearCanvas('empSig')">Clear Employee Signature</button>
    </div>

    <!-- File Uploads -->
    <div id="photoInputsContainer">
      <label>Photos:</label>
      <input type="file" accept="image/*" class="photo-input" />
    </div>

    <div id="videoInputsContainer">
      <label>Videos:</label>
      <input type="file" accept="video/*" class="video-input" />
    </div>

    <button class="btn-primary" onclick="generatePDF()">Generate & Share</button>
  </div>

  <script>
    let drawing = false;
    let lastValidText = "";

    function setupSigPad(canvas) {
      const ctx = canvas.getContext("2d");
      canvas.addEventListener("touchstart", e => e.preventDefault(), { passive: false });
      canvas.addEventListener("touchmove", e => e.preventDefault(), { passive: false });
      canvas.addEventListener("pointerdown", e => {
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
      });
      canvas.addEventListener("pointermove", e => {
        if (!drawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      });
      canvas.addEventListener("pointerup", () => drawing = false);
      canvas.addEventListener("pointerleave", () => drawing = false);
    }

    function clearCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    const canvas = document.getElementById("empSig");
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    setupSigPad(canvas);
    // Set today's date as default
    document.getElementById("reportDate").valueAsDate = new Date();

    const textarea = document.getElementById("conditionReport");
    const warning = document.getElementById("limitWarning");

    // Text field limits based on PDF coordinates
    const fieldLimits = {
      equipmentSNG: { maxWidth: 301.1 - 144.60 }, // 156.5
      manufacturer: { maxWidth: 301.1 - 144.60 }, // 156.5
      partNumber: { maxWidth: 301.1 - 144.6 }, // 156.5
      aircraftSerial: { maxWidth: 301.1 - 144.6 }, // 156.5
      partDescription: { maxWidth: 553 - 396.52 }, // 156.48
      modelNumber: { maxWidth: 553 - 396.52 }, // 156.48
      serialNumber: { maxWidth: 553 - 396.52 }, // 156.48
      nameDate: { maxWidth: 551 - 260 } // 291
    };

    // Apply limits to text input fields
    function setupFieldLimit(fieldId, maxWidth) {
      const field = document.getElementById(fieldId);
      let lastValidValue = "";
      
      field.addEventListener("input", async (e) => {
        const pdfDoc = await PDFLib.PDFDocument.create();
        const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        const textWidth = font.widthOfTextAtSize(field.value, 10);
        
        if (textWidth > maxWidth) {
          field.value = lastValidValue;
          e.preventDefault();
        } else {
          lastValidValue = field.value;
        }
      });
      
      field.addEventListener("keydown", async (e) => {
        const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'Tab'];
        if (allowedKeys.includes(e.key) || e.ctrlKey || e.metaKey) return;
        
        const pdfDoc = await PDFLib.PDFDocument.create();
        const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        const testText = field.value + (e.key.length === 1 ? e.key : '');
        const textWidth = font.widthOfTextAtSize(testText, 10);
        
        if (textWidth > maxWidth) {
          e.preventDefault();
        }
      });
    }

    // Setup limits for all fields
    setupFieldLimit('equipmentSNG', fieldLimits.equipmentSNG.maxWidth);
    setupFieldLimit('manufacturer', fieldLimits.manufacturer.maxWidth);
    setupFieldLimit('partNumber', fieldLimits.partNumber.maxWidth);
    setupFieldLimit('aircraftSerial', fieldLimits.aircraftSerial.maxWidth);
    setupFieldLimit('partDescription', fieldLimits.partDescription.maxWidth);
    setupFieldLimit('modelNumber', fieldLimits.modelNumber.maxWidth);
    setupFieldLimit('serialNumber', fieldLimits.serialNumber.maxWidth);

    // Special handling for name and date combined
    function checkNameDateLimit() {
      const employeeName = document.getElementById("employeeName").value;
      const reportDate = document.getElementById("reportDate").value;
      const formattedDate = reportDate ? formatDate(reportDate) : '';
      const combinedText = `${employeeName}, ${formattedDate}`;
      return combinedText;
    }

    document.getElementById('employeeName').addEventListener('input', async (e) => {
      const pdfDoc = await PDFLib.PDFDocument.create();
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
      const combinedText = checkNameDateLimit();
      const textWidth = font.widthOfTextAtSize(combinedText, 10);
      
      if (textWidth > fieldLimits.nameDate.maxWidth) {
        e.target.value = e.target.value.slice(0, -1);
      }
    });

    textarea.addEventListener("input", async (e) => {
      const pdfDoc = await PDFLib.PDFDocument.create();
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
      const wrappedLines = wrapText(textarea.value, font, 10, 488);
      if (wrappedLines.length > 6) {
        textarea.value = lastValidText;
        warning.style.display = "block";
        e.preventDefault();
      } else {
        lastValidText = textarea.value;
        warning.style.display = "none";
      }
    });

    textarea.addEventListener("keydown", async (e) => {
      const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'Tab'];
      if (allowedKeys.includes(e.key) || e.ctrlKey || e.metaKey) return;

      const pdfDoc = await PDFLib.PDFDocument.create();
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
      const testText = textarea.value + (e.key.length === 1 ? e.key : '');
      const wrappedLines = wrapText(testText, font, 10, 488);
      if (wrappedLines.length > 6) {
        e.preventDefault();
        warning.style.display = "block";
      }
    });

    // Add new photo input on file select
    document.getElementById('photoInputsContainer').addEventListener('change', (e) => {
      if (e.target.classList.contains('photo-input') && e.target.files.length > 0) {
        e.target.disabled = true;
        const newInput = document.createElement('input');
        newInput.type = 'file';
        newInput.accept = 'image/*';
        newInput.className = 'photo-input';
        document.getElementById('photoInputsContainer').appendChild(newInput);
      }
    });

    // Add new video input on file select
    document.getElementById('videoInputsContainer').addEventListener('change', (e) => {
      if (e.target.classList.contains('video-input') && e.target.files.length > 0) {
        e.target.disabled = true;
        const newInput = document.createElement('input');
        newInput.type = 'file';
        newInput.accept = 'video/*';
        newInput.className = 'video-input';
        document.getElementById('videoInputsContainer').appendChild(newInput);
      }
    });

    function renameFile(file, newName) {
      return new File([file], newName, { type: file.type });
    }
    
    function getFileExtension(filename) {
      return filename.slice(filename.lastIndexOf('.'));
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    async function generatePDF() {
      const existingPdfBytes = await fetch("SmallReport.pdf").then(res => res.arrayBuffer());
      const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
      const pages = pdfDoc.getPages();
      const firstPage = pages[0];
      const { height } = firstPage.getSize();
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

      // Status checkboxes - add X to selected option
      const selectedStatus = document.querySelector('input[name="status"]:checked');
      if (selectedStatus) {
        const statusCoords = {
          'lost': { x: 96.88, y: height - 99.51 },
          'damaged': { x: 241, y: height - 99.51 },
          'inactivated': { x: 422, y: height - 99.51 }
        };
        const coord = statusCoords[selectedStatus.value];
        firstPage.drawText('X', {
          x: coord.x,
          y: coord.y,
          size: 12,
          font
        });
      }

      // Equipment fields (left column)
      const equipmentSNG = document.getElementById("equipmentSNG").value;
      const manufacturer = document.getElementById("manufacturer").value;
      const partNumber = document.getElementById("partNumber").value;
      const aircraftSerial = document.getElementById("aircraftSerial").value;

      firstPage.drawText(equipmentSNG, { x: 144.60, y: height - 123.86, size: 10, font });
      firstPage.drawText(manufacturer, { x: 144.60, y: height - 141.87, size: 10, font });
      firstPage.drawText(partNumber, { x: 144.6, y: height - 159.9, size: 10, font });
      firstPage.drawText(aircraftSerial, { x: 144.6, y: height - 177.87, size: 10, font });

      // Equipment fields (right column)
      const partDescription = document.getElementById("partDescription").value;
      const modelNumber = document.getElementById("modelNumber").value;
      const serialNumber = document.getElementById("serialNumber").value;

      firstPage.drawText(partDescription, { x: 396.52, y: height - 123.86, size: 10, font });
      firstPage.drawText(modelNumber, { x: 396.52, y: height - 141.87, size: 10, font });
      firstPage.drawText(serialNumber, { x: 396.52, y: height - 159.9, size: 10, font });

      // Name and Date (updated coordinates)
      const employeeName = document.getElementById("employeeName").value;
      const reportDate = document.getElementById("reportDate").value;
      const formattedDate = reportDate ? formatDate(reportDate) : '';
      const employeeId = document.getElementById("employeeId").value.trim();
      const nameDateId = `${employeeName}, ${employeeId}, ${formattedDate}`;
      
      firstPage.drawText(nameDateId, { x: 260, y: height - 380.5, size: 10, font });


      // Condition Report (existing code)
      const startX = 63;
      const startY_topOrigin = 237.53;
      const endY_topOrigin = 327.6;
      const startY_pdf = height - startY_topOrigin;
      const endY_pdf = height - endY_topOrigin;
      const totalHeight = startY_pdf - endY_pdf;
      const lineSpacing = totalHeight / 5;
      const maxWidth = 488;
      const wrappedLines = wrapText(textarea.value, font, 10, maxWidth).slice(0, 6);

      wrappedLines.forEach((line, i) => {
        firstPage.drawText(line, {
          x: startX,
          y: startY_pdf - (i * lineSpacing),
          size: 10,
          font
        });
      });

      // Employee Signature (updated coordinates)
      const pngUrl = document.getElementById("empSig").toDataURL();
      const pngImageBytes = await fetch(pngUrl).then(res => res.arrayBuffer());
      const sigImage = await pdfDoc.embedPng(pngImageBytes);
      firstPage.drawImage(sigImage, { x: 106, y: height - 350 - 40, width: 150, height: 40 });

      const pdfBytes = await pdfDoc.save();
      const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
      const renamedPdf = renameFile(new File([pdfBlob], 'ToolDispositionForm.pdf', { type: 'application/pdf' }), 'ToolDispositionForm.pdf');

      const files = [renamedPdf];

      
    const files = [renamedPdf];

  // Prepare safe part description
    let partDescValue = document.getElementById("partDescription").value.trim().replace(/[^\w\s-]/g, "").replace(/\s+/g, "_");
    if (partDescValue) partDescValue = "_" + partDescValue; // only prefix underscore if not empty

  // Photos
    const photoInputs = document.querySelectorAll('.photo-input');
    let photoIndex = 1;
    photoInputs.forEach(input => {
      if (input.files.length > 0) {
        for (const file of input.files) {
          files.push(renameFile(file, `photo_${photoIndex++}${partDescValue}${getFileExtension(file.name)}`));
      }
    }
  });

  // Videos
    const videoInputs = document.querySelectorAll('.video-input');
    let videoIndex = 1;
    videoInputs.forEach(input => {
      if (input.files.length > 0) {
        for (const file of input.files) {
          files.push(renameFile(file, `video_${videoIndex++}${partDescValue}${getFileExtension(file.name)}`));
      }
    }
  });


      if (navigator.canShare && navigator.canShare({ files })) {
        await navigator.share({ files, title: 'TOOL DISPOSITION FORM', text: 'See attached form + media' });
      } else {
        alert("Sharing not supported on this device. PDF generated.");
        const url = URL.createObjectURL(pdfBlob);
        window.open(url);
      }
    }

    function wrapText(text, font, fontSize, maxWidth) {
      const words = text.split(/\s+/);
      const lines = [];
      let currentLine = "";

      words.forEach(word => {
        const testLine = currentLine ? currentLine + " " + word : word;
        const width = font.widthOfTextAtSize(testLine, fontSize);

        if (width > maxWidth && currentLine) {
          lines.push(currentLine);
          currentLine = word;
        } else {
          currentLine = testLine;
        }
      });

      if (currentLine) lines.push(currentLine);
      return lines;
    }
  </script>
</body>
</html>
